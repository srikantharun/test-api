### PD Release generation for Europa

#### Configuration
Before running the script, ensure that the command line arguments are clear and Release Type is set correctly:

Block (-b, --block): The specific block within the project for which the release is generated.
Release Type (-t, --relType): Specifies whether the release is for a block or the entire top-level design.
Release Directory Path (-r, --relDirPath): The file path where the release should be generated. If not specified, defaults to "/data/releases/europa/"
Release Format (-rf, --relFormat): Either 'hier' for hierarchical or 'flat' for flat directory structure.
DFT (-d, --dft): Boolean flag to include Design For Testability features in the release.
Copy All (-ca, --copyAll): Boolean flag to copy all files during the release process.

#### Usage
Run the following `make` command followed by the `pd_release_flat` target:

To generate a release for a specific block:

```bash
cd europa
source .env-default-modules
make pd_release_flat REL_TYPE=block REL_BLOCK=l2
```

For all blocks, set REL_BLOCK to all:
```bash
cd europa
source .env-default-modules
make pd_release_flat REL_TYPE=block REL_BLOCK=all
```
To generate a release for top-level
```
cd europa
source .env-default-modules
make pd_release_flat REL_TYPE=top REL_BLOCK=europa
```

By default, the release will be generated at `/data/releases/europa/`

For blocks not residing directly inside `hw/impl/europa/blocks/` provide the relative path(from `hw/impl/europa/blocks/`) for the block to be released.
For example, to generate a release for the `noc/noc_h_ddr_west`, use the following command:

```bash
cd europa
source .env-default-modules
make pd_release_flat REL_TYPE=block REL_BLOCK=noc/noc_h_ddr_west
```

The resulting release will be placed in the path:
```
/data/releases/europa/noc/noc_h_ddr_west/202407080823/
```

The follwoing command creates a local release in the current working directory:

```bash
make pd_release_flat REL_TYPE=block REL_BLOCK=all REL_DIR_FLAT=`pwd`/release
```

The script also ensures that, when the option `all` is used, the release folder name for all the release IPs will be the same.

By default all releases are created with DFT, to disable DFT set `REL_DFT_ENABLE` to false:

```bash
make pd_release_flat REL_TYPE=block REL_BLOCK=all REL_DIR_FLAT=`pwd`/release REL_DFT_ENABLE=false
```

#### Key Variables
- `REL_TYPE`: Type of release (e.g., top or block).
- `REL_BLOCK`: Specific block to create a release for (`all` or one at a time: `ai_core`).
- `REL_DIR_FLAT`: Specify the release directory (Default: /data/releases/europa/)
- `REL_DFT_ENABLE`: Specify DFT enable or disable (true/false)
- `REL_COPY_ALL`: Copies non-repo files (e.g. files under `/data/foundry/`) to the release dir instead of pointing to them

#### Functional Details
The release script at `europa/hw/scripts/pd_release/pd_release.py` generates a release for Europa. The default location is: `/data/releases/europa/`.
The script creates a directory structure with likely tops in the release area, eg:

```
/data/releases/europa/
|__ top_aipu
|__ aic_mid
|__ aic
|__ ...
```

The script generates a directory for each top (eg `mvm_iau_dpu`) if it doesn't already exist, and generates the release inside a date-timestamped release area eg:

```
/data/releases/europa/aic_mid
|__ 202405011015
|__ 202404242020
|__ ...
```

The timestamp directory above is autogenerated based on when the release script is run. After generation, these directories are marked Read Only. This directory contains all the .sv files and corresponding file lists. The file list is named in the format: `<partition_top>.read_rtl.tcl`

### PD Release Cleanup

#### Usage
The PD release cleanup script can be run using the following command from Europa repo root:
```bash
make pd_release_clean
```
The command above runs the cleanup script(detailed below) with the following default options:

- `-d, --dir`: `/data/releases/europa/`
- `-k, --keep-file`: `hw/scripts/pd_release/pd_release.keep`
- `-w, --weeks-old`: `12`
- `-l, --log-dir`: `/data/releases/europa/cleanup_logs/`
- `-f, --force`

#### Key Make Variables

- `REL_DIR_FLAT`: Points to the flat release directory where PD release is stored. This is the directory targeted for cleanup by the `pd_release_clean` target. Default: `"/data/releases/europa/"`
- `REL_KEEP_DURATION`: The duration in weeks for which releases should be kept before they are eligible for cleanup. Releases older than this duration will be considered for deletion, unless protected by keep rules. Default: `12`
- `REL_KEEP_FILE`: Path to the file that contains rules or patterns specifying which releases should not be deleted during cleanup. This file helps prevent accidental deletion of important releases. Default: `$(GIT_REPO)/hw/scripts/pd_release/pd_release.keep`
- `REL_CLEANUP_LOG`: Specifies the directory where logs related to the cleanup process should be stored. This helps in auditing and troubleshooting the cleanup operations. Default: `$(REL_DIR_FLAT)/cleanup_logs/`

Example usage:
```bash
make pd_release_clean REL_KEEP_DURATION=16
```
This command will apply the custom keep duration for the cleanup process, while other settings remain as defined by their defaults.

#### Implementation Details

##### Description
The PD release cleanup script is designed to manage the cleanup of old releases. It deletes releases that are older than a given threshold, unless they are protected by regex patterns specified in the "keep file".

##### Features
- Directory Deletion: Recursively deletes releases that are older than a specified number of weeks.
- Protection via Regex: Supports a keep file with regex patterns to protect specific releases from deletion.
- User Confirmation: Optionally requires user confirmation before deleting each directory to prevent accidental data loss.
- Logging: Logs all operations, providing a detailed account of actions taken and any errors encountered.

##### Script Usage
Run the script from the command line, specifying the necessary options. Below are the available command-line options:

- `-d, --dir`: Specifies the root directory where releases are stored. Default is the current working directory.
- `-k, --keep-file`: Specifies the path to the keep file that contains regex patterns for directories not to delete. Default is `hw/scripts/pd_release/pd_release.keep`.
- `-w, --weeks-old`: Age in weeks beyond which releases should be deleted if not protected by the keep file. Default is 12 weeks.
- `-l, --log-dir`: Specifies the directory to save log files. If not specified, logs are saved in the current directory.
- `-f, --force`: Skips confirmation before deleting each directory, useful for automated environments.

###### Example Command
```bash
python pd_cleanup_script.py --dir /path/to/releases --weeks-old 12 --force
```

This command will run the cleanup process on `/path/to/releases`, deleting directories older than 12 weeks without asking for confirmation.

##### Notes
- Ensure that the keep file is correctly formatted with valid regex patterns, as any error in these patterns could halt the script execution.
- Running the script with administrative or sufficient permissions is required since it involves modifying file permissions and deleting directories.
