#!/usr/bin/env bash

set -e

VENV=.venv/regtool

make -C $REPO_ROOT/bin venv VENV=$VENV FILE=$REPO_ROOT/hw/scripts/reggen/regtool-requirements.txt > /dev/null 2>&1

# use flock to make it thread safe
(
flock ${file_descriptor}
source $REPO_ROOT/bin/$VENV/bin/activate
python3.10 $REPO_ROOT/hw/scripts/reggen/ipgen.py $@
deactivate
) {file_descriptor}>$REPO_ROOT/bin/.ipgen.lock
