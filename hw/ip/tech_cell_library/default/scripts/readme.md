# Bender and TCL automation of flow infra for the axelera tech cell library

This automation flow is designed for generating TCL and Bender configuration files from a YAML config file. Previously tech cells needed to be declared in these 2 files in order to run simulation and synthesis individually. This can easily bring misalignment if one dose not update both files. This flow by automating the generation of these 2 files, averts any issues due to misalignment.

## Usage

### Running and generating the files

To generate the files, simply do:

```bash
make -C $REPO_ROOT gen_axe_tcl
```

This will pick up the `axe_tcl_config.yml` file from current working directory and generate the `tc_techlib.tcl` and `bender.yml` files.
Please note, this will over-write and existing files. Further documentation details how the makefile can be updates to suit your use case.

### Makefile and Associated Scripts

#### Makefile

##### Variables
- `AXE_TCL_GIT_REPO`: Directory of the top-level Git repository. Automatically determined by the makefile.
- `AXE_TCL_CONFIG_YML`: Path to the main YAML configuration file (`axe_tcl_config.yml` by default).
- `AXE_TCL_YAML_DEPS`: Dependencies for generating configuration files, includes `AXE_TCL_CONFIG_YML` and `ips.yml`.
- `AXE_TCL_SCRIPT`: Path to the Bash script used to invoke the Python script for generating configurations.
- `AXE_TCL_BENDER_FILE`, `AXE_TCL_TCL_TECHLIB`: Output file names for Bender and TCL configuration files respectively.
- `AXE_TCL_LOG_FILE`: Log file name.
- `AXE_TCL_OUTPUTS`: Collection of all outputs generated by the process.

##### Targets
- `gen_axe_tcl`: Default target which generates the Bender and TCL files by invoking the associated Bash script with the necessary arguments.
- `clean`: Removes all generated output files to clean the directory.

#### Bash Script (`gen_axe_tcl_config.sh`)

##### Functionality
1. Ensures a Python virtual environment is set up and activated.
2. Installs required Python packages.
3. Invokes a Python script to generate the configuration files.

##### Usage
This script is invoked by the Makefile and expects the same command-line arguments required by the python script below to specify YAML input, output paths for generated files, and a debug level.

#### Python Script (`gen_axe_tcl_config.py`)

##### Overview
Generates two files, a Bender configuration file and a TCL file, from a specified YAML configuration file.

##### Usage

###### Example Command
To run the script manually (typically handled by the Bash script):
```bash
python3 gen_axe_tcl_config.py -y path/to/config.yml -t output.tcl -b output.yml -d debug
```

Command-line arguments:
- `-y` (`--yaml_path`): Specifies the input YAML file path.
- `-t` (`--tcl_output_path`): Specifies the output path for the TCL configuration file.
- `-b` (`--bender_output_path`): Specifies the output path for the Bender configuration file.
- `-d` (`--debug_level`): Sets the logging level (`debug`, `info`, `warning`, `error`, `critical`).

Note: the file is intended to be called from the bash script unless the python environment is setup properly with all the required packages.

## YAML Config Details

The `axe_tcl_config.yml` YAML files provides the specifications for the configuration files that will be generated.

#### `axe_tcl_config.yml`

This YAML configuration file is structured to specify the config needed to generate the files.

##### Sections:

###### 1. Meta Information:
   - Contains `name`, `description` and`authors`information regarding the config.

###### 2. IP Specifications:
   - This section allows for modular management of IP configurations, which can be maintained separately from the main configuration. It uses the `!include` directive to incorporate external YAML configurations from a file located relative to this configuration. The included `ips.yml` can be maintained at one place while being imported into multiple configs. 

###### 3. TCL Specifications:
   - Defines various paths used in TCL scripts relevant to the technology library locations, standard cells etc.
   - `paths`: Specifies environment variables and paths to different components within the technology library.
   - `mem_ip`: Outlines memory IP configurations for different levels (like l1, l2) and specific wrappers, with references to macros defined in the included `ips.yml`.

###### 4. Bender Specifications:
   - `dependencies`: Specifies packages and their paths required for the Bender.
   - `sources`: Lists simulation and RTL source files categorized under various targets. References used wherever possible.

#### IP Description `ips.yml`

This file contains definitions of various IP blocks used in the configurations. It is structured to define macros for different IPs with specific attributes like path and macro name, which can be referenced in the main configuration file.

##### Structure:

- Top-level keys represent IPs (e.g., AX65, DPU, L1, L2).
- Each category contains a list of `macros`, which are predefined aliases (`&label`) that hold the details for specific IP blocks:
  - `macro`: Name of the IP block.
  - `path`: Directory path where the IP block is located.
  - `suffix`: Optional field to specify a suffix for the IP name, used to determine the location of the IP.

##### Referencing:
- Aliases (e.g., `&ax65_macro_1`) are defined to reuse the configurations across multiple parts of the YAML documents, both within `ips.yml` itself and in the main `axe_tcl_config.yml`. This avoids duplication and eases maintenance of IP configurations.

###### Example Usage in Main Configuration:
- In `axe_tcl_config.yml`, under `mem_ip` or `sources`, references such as `*l1_macro_1` are used. This means the details defined under the alias `&l1_macro_1` in `ips.yml` are being applied in the main configuration file.

###### Example YAML Structure for `axe_tcl_config.yml`

```yaml
#####################################################
# Meta Information for the file
#####################################################

meta:
  name: axe_tcl_pkg
  description: "Description of the config file"
  authors: 
    - "<user-name>@axelera.ai"

#####################################################
# IP specifications - Include from a separate file
#####################################################

!include ips.yml

#####################################################
# TCL specifications
#####################################################

paths:
  TECH_HOME: "/data/foundry/samsung/sf5a"
  STD_CELL_HOME: "${TECH_HOME}/std_cell/samsung"
  HOME: "${TECH_HOME}/memory/samsung/generated"

mem_ip:
  l1:
    MEM_LIBS:
      - *l1_macro_1

#####################################################
# Bender Specifications
#####################################################

dependencies:
  axe_tcl_pkg: 
    path: "pkg"

sources:
  - target: all(asic, sf5a, simulation)
    files:
      - *l1_macros
```

###### Example YAML Structure for `ips.yml`

```yaml
ips:
  L1:
    macros: &l1_macros
      - &l1_macro_1
        macro: ln05lpe_a00_mc_ra1rwp_hsr_rvt_4096x128m4b4c1r1
        path: ln05lpe_a00_mc_ra1rwp_hsr_rvt_V2.01/dev
        suffix: _c_lvf_dth
```
