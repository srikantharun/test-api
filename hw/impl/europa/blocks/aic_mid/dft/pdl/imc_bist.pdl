iProcsForModule aic_mid_p

iProc clear_imc_bist_cmd { } {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CMD
    iNote -comment "Clearing IMC BIST CMD..."
    iWrite tdr[3:0] 0x0
    iApply
    iPrefix ""
}

iProc clear_imc_bist_cfg { } {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CFG
    iNote -comment "Clearing IMC BIST CFG..."
    iWrite tdr[12:4] 0x000
    iApply
    iPrefix ""
}

# bira_mode == 0: bira disabled
# bira_mode == 1: run mbist algorithm only
# bira_mode == 2: run cbist algorithm only
# bira_mode == 3: run both algorithms
iProc enable_bira_mode { {bira_mode 3} {max_repair_attempts 7} } {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CFG
    iWrite tdr[10:9] ${bira_mode}
    iWrite tdr[8:4]  ${max_repair_attempts}
    iApply
    iPrefix ""
}

iProc enable_burnin_mode { } {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CFG
    iWrite tdr[11] 0x1
    iApply
    iPrefix ""
}

iProc enable_fail_analysis_mode { } {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CFG
    iWrite tdr[12] 0x1
    iApply
    iPrefix ""
}

iProc start_imc_mbist {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CMD
    iNote -comment "Starting IMC MBIST..."
    iWrite tdr[3:0] 0x01
    iApply
    iPrefix ""
}

iProc start_imc_cbist {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CMD
    iNote -comment "Starting IMC CBIST..."
    iWrite tdr[3:0] 0x02
    iApply
    iPrefix ""
}

iProc resume_imc_bist {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CMD
    iNote -comment "Resuming IMC BIST..."
    iWrite tdr[4:0] 0x04
    iApply
    iPrefix ""
}

iProc stop_imc_bist {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: CMD
    iNote -comment "Stopping IMC BIST..."
    iWrite tdr[4:0] 0x08
    iApply
    iPrefix ""
}

iProc read_imc_bist_status_expect_done_pass_no_repair {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: STATUS
    iNote -comment "Reading IMC BIST status... Expect 0x6 (done, pass)."
    iRead tdr 0x6
    iApply
    iPrefix ""
}

iProc read_imc_bist_status_expect_done_pass {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: STATUS
    iNote -comment "Reading IMC BIST status... Expect 0x6 (done, pass). Accepting either status of repair_needed."
    # error_bank, col, cycle not compared either because a successful repair will report repaired location info
    iRead tdr 0bxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx110
    iApply
    iPrefix ""
}

iProc read_imc_bist_status_expect_busy {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: STATUS
    iNote -comment "Reading IMC BIST status... Expect 0x1 (busy)."
    iRead tdr 0x1
    iApply
    iPrefix ""
}

iProc read_imc_bist_status_expect_not_started {} {
    iPrefix u_aic_mid_u_mvm_i_mvm_jtag_tdr_i_mvm_jtag_tdr_core_aic_mid_p_rtl1_tessent_tdr_imc_bist_inst
    # Scope: STATUS
    iNote -comment "Reading IMC BIST status... Expect 0x0 (not started)."
    iRead tdr 0x0
    iApply
    iPrefix ""
}

# Tests for subip simulation
iProc test_imc_mbist {} {
    start_imc_mbist

    iRunLoop 2000 -tck
    iApply

    read_imc_bist_status_expect_done_pass_no_repair
}

iProc test_imc_cbist {} {
    start_imc_cbist

    iRunLoop 1000 -tck
    iApply

    read_imc_bist_status_expect_done_pass_no_repair
}

iProc test_imc_mbist_bira_mode {} {
    enable_bira_mode 1 7
    start_imc_mbist

    iRunLoop 4500 -tck
    iApply

    read_imc_bist_status_expect_done_pass
}

iProc test_imc_cbist_bira_mode {} {
    enable_bira_mode 2 7
    start_imc_cbist

    iRunLoop 2500 -tck
    iApply

    read_imc_bist_status_expect_done_pass
}

iProc test_imc_bira_bisr_prod_mode {} {
    enable_bira_mode 3 7
    # when bira_mode == 3 (both algorithms), doesn't matter if we start mbist or cbist
    # the controller will run both modes
    start_imc_mbist

    iRunLoop 7000 -tck
    iApply

    read_imc_bist_status_expect_done_pass
}
